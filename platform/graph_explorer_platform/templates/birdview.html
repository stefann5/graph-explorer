<script>

    let miniMapLinks;
    let miniMapNodes;
    let miniMap;
    let isMiniMapScaled = false;

    function initializeMiniMap(links, force) {
        miniMap = d3.select("#bird-view")
            .append("svg")
            .attr("opacity", 0)
            .attr("width", "100%")
            .attr("height", "100%")
            .append("g")
            .attr("id", "mini-map");

        miniMapLinks = miniMap.selectAll(".link").data(links);
        miniMapLinks.enter()
            .append("line")
            .attr("class", "link");

        miniMapNodes = miniMap.selectAll(".node").data(force.nodes());
        miniMapNodes.enter()
            .append("circle")
            .attr("class", "node")
            .attr("r", 20);

        force.on("end", scaleAndPositionMiniMap);
    }

    function updateMiniMap() {
        miniMapLinks
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        miniMapNodes
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
    }

    function scaleAndPositionMiniMap() {
        if (isMiniMapScaled) return;
        isMiniMapScaled = true;

        d3.select("#bird-view svg").attr("opacity", 1.0);

        const containerDimensions = getDimensions("#bird-view");
        const miniMapDimensions = getDimensions("#mini-map");

        const scaleWidth = (containerDimensions.width * 0.75) / miniMapDimensions.width;
        const scaleHeight = (containerDimensions.height * 0.75) / miniMapDimensions.height;

        const translateX = (miniMapDimensions.width - containerDimensions.width) / 2 * 1.2;
        const translateY = (miniMapDimensions.height - containerDimensions.height) / 2 * 1.2;

        const transformation = `translate(${translateX}, ${translateY}) scale(${scaleWidth}, ${scaleHeight})`;
        d3.select("#mini-map").attr("transform", transformation);
    }

    function getDimensions(selector) {
        const rect = d3.select(selector).node().getBoundingClientRect();
        return { width: rect.width, height: rect.height };
    }

</script>